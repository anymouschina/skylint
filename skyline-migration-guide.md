# WebView 迁移到 Skyline 指南

## 1. 概述

本文档详细说明了从 WebView 渲染引擎迁移到 Skyline 渲染引擎的规则识别和需要修改的内容。Skyline 是微信小程序的新一代渲染引擎，提供了更好的性能和更丰富的功能。

## 2. 迁移规则识别

### 2.1 渲染引擎配置

- 在 `app.json` 中需要设置 `"renderer": "skyline"`
- 建议开启按需注入特性：`"lazyCodeLoading": "requiredComponents"`

### 2.2 样式相关规则

#### 2.2.1 布局相关
- `display: flex` 规则检查
- `display: inline` 规则检查
- `position: fixed` 规则检查
  - 必须指定 top/bottom 和 left/right 偏移值
  - Skyline 暂不支持 stacking context，需要自行确认 z-index 层级
- `box-sizing` 规则检查

#### 2.2.2 文本相关
- `text-overflow: ellipse` 规则检查
- 内联文本规则检查

#### 2.2.3 动画相关
- CSS 动画规则检查
  - 不支持 CSS animation
  - 建议使用 Skyline 的 worklet 动画替代
- 不支持 `calc()` 函数
  - 需要改为静态值
  - 可以使用兼容写法：`height: 100px; height: calc(50px+3rem);`，这样在 Skyline 下使用静态值，WebView 下使用 calc 函数

### 2.3 组件相关规则

#### 2.3.1 导航相关
- 原生导航规则检查
- 自定义导航规则检查

#### 2.3.2 滚动相关
- `scroll-view` 组件规则检查
  - 必须显式指定 `type="list"`
  - 暂不支持水平垂直方向同时滚动
  - 直接子节点的 margin 无效，需要套多一层 view
  - 需要充分利用按需渲染机制，避免只有一个直接子节点
- 禁用滚动规则检查

#### 2.3.3 其他组件
- SVG 样式标签规则检查
- 不支持的组件规则检查

### 2.4 模板相关规则

- 模板引用规则检查
- 模板命名规则检查
- 模板作用域规则检查

### 2.5 uni-app 相关规则

#### 2.5.1 组件相关
- uni-app 特有组件检查
  - `uni-button`, `uni-checkbox`, `uni-radio` 等组件
  - 需要检查这些组件在 Skyline 下的兼容性
  - 可能需要使用原生组件替代

#### 2.5.2 属性相关
- uni-app 特有属性检查
  - `uni-` 和 `u-` 前缀的属性
  - 需要检查这些属性在 Skyline 下的兼容性
  - 可能需要使用原生属性替代

#### 2.5.3 样式相关
- uni-app 特有样式检查
  - `uni-` 和 `u-` 前缀的样式
  - 需要检查这些样式在 Skyline 下的兼容性
  - 可能需要使用原生样式替代

## 3. 需要修改的内容

### 3.1 配置文件修改

1. `app.json` 修改：
```json
{
  "renderer": "skyline",
  "lazyCodeLoading": "requiredComponents"
}
```

2. 页面级配置：
```json
{
  "renderer": "skyline"
}
```

### 3.2 样式修改

1. 布局相关：
   - 检查并修改 `position: fixed` 的使用
     - 确保指定了 top/bottom 和 left/right 偏移值
     - 注意 z-index 层级问题
   - 确保 `display: flex` 的正确使用
   - 避免使用 `display: inline`

2. 文本相关：
   - 使用 `text-overflow: ellipse` 替代其他文本截断方案
   - 避免内联文本样式

3. 动画相关：
   - 使用 Skyline 的 worklet 动画替代 CSS animation
   - 避免使用 `calc()` 函数，改用静态值或兼容写法

### 3.3 组件修改

1. 导航相关：
   - 使用 Skyline 支持的导航方案
   - 避免使用原生导航

2. 滚动相关：
   - 正确使用 `scroll-view` 组件
     - 添加 `type="list"` 属性
     - 避免同时使用 `scroll-x` 和 `scroll-y`
     - 为需要 margin 的直接子节点套多一层 view
     - 优化子节点结构，避免只有一个直接子节点
   - 处理滚动禁用场景

3. 其他组件：
   - 替换不支持的组件
   - 修改 SVG 使用方式

### 3.4 模板修改

1. 模板引用：
   - 确保模板引用路径正确
   - 处理模板作用域问题

2. 模板命名：
   - 避免命名冲突
   - 使用合理的命名规范

### 3.5 uni-app 项目修改

1. 组件修改：
   - 检查并替换 uni-app 特有组件
   - 使用原生组件替代不兼容的组件
   - 修改组件的属性和事件处理

2. 属性修改：
   - 检查并替换 uni-app 特有属性
   - 使用原生属性替代不兼容的属性
   - 修改属性的使用方式

3. 样式修改：
   - 检查并替换 uni-app 特有样式
   - 使用原生样式替代不兼容的样式
   - 修改样式的使用方式

## 4. 迁移步骤

1. 配置迁移：
   - 修改 `app.json` 启用 Skyline
   - 开启按需注入特性

2. 页面迁移：
   - 逐个页面迁移
   - 修改页面配置

3. 组件迁移：
   - 检查并修改不兼容的组件
   - 更新组件使用方式

4. 样式迁移：
   - 检查并修改不兼容的样式
   - 优化布局方案

5. 测试验证：
   - 功能测试
   - 性能测试
   - 兼容性测试

6. uni-app 项目迁移：
   - 检查 uni-app 特有组件
   - 检查 uni-app 特有属性
   - 检查 uni-app 特有样式
   - 替换不兼容的内容

## 5. 注意事项

1. 性能优化：
   - 避免过度使用 `position: fixed`
   - 优化滚动性能
   - 合理使用动画

2. 兼容性：
   - 处理不同设备尺寸
   - 处理不同系统版本

3. 调试：
   - 使用开发者工具调试
   - 监控性能指标

4. uni-app 项目注意事项：
   - 注意 uni-app 特有组件的兼容性
   - 注意 uni-app 特有属性的兼容性
   - 注意 uni-app 特有样式的兼容性
   - 使用原生组件和属性替代不兼容的内容

## 6. 工具支持

本项目提供了以下工具支持迁移：

1. 规则检查：
   - 样式规则检查
   - 组件规则检查
   - 模板规则检查

2. 自动修复：
   - 样式自动修复
   - 组件自动修复
   - 模板自动修复

3. 代码分析：
   - AST 分析
   - 依赖分析
   - 性能分析

4. uni-app 项目支持：
   - uni-app 组件检查
   - uni-app 属性检查
   - uni-app 样式检查
   - 自动修复建议

## 7. 常见问题

1. 样式问题：
   - 布局错乱
   - 动画不生效
   - 文本显示异常

2. 组件问题：
   - 组件不显示
   - 事件不响应
   - 性能问题

3. 性能问题：
   - 滚动卡顿
   - 动画卡顿
   - 内存占用高

4. uni-app 项目问题：
   - 组件不兼容
   - 属性不兼容
   - 样式不兼容
   - 性能问题

## 8. 参考资料

1. 官方文档：
   - Skyline 渲染引擎文档
   - 迁移指南
   - 性能优化指南

2. 最佳实践：
   - 布局最佳实践
   - 动画最佳实践
   - 性能最佳实践

3. uni-app 相关文档：
   - uni-app 组件文档
   - uni-app 属性文档
   - uni-app 样式文档
   - uni-app 迁移指南 